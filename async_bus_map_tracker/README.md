# Автобусы на карте Москвы

Веб-приложение показывает передвижение автобусов на карте Москвы.

<img src="screenshots/buses.gif" alt="buses">

## Как запустить

- Скачайте код
- Откройте в браузере файл index.html
- Запустите сервер server.py
```shell
python server.py
```
- Запустите имитатор автобусов fake_bus.py
```shell
python fake_bus.py
```

### Настройка CLI
### Аргументы командной строки fake_bus.py
- `-pr` `--server_protocol` - протокол сервера
- `-sh` `--server_host` - адрес сервера
- `-sp` `--server_port` - порт сервера
- `-rn` `--routes_number` — количество маршрутов
- `-bpr` `--buses_per_route` — количество автобусов на каждом маршруте
- `-ws_n` `--websockets_number` — количество открытых веб-сокетов
- `-e_id` `--emulator_id` — префикс к busId на случай запуска нескольких экземпляров имитатора
- `-rt` `--refresh_timeout` — задержка в обновлении координат сервера
- `-v` `--logging` — настройка логирования

### Аргументы командной строки server.py
- `-pr` `--server_protocol` - протокол сервера
- `-sh` `--server_host` - адрес сервера
- `-bp` `--browser_port` - порт для имитатора автобусов
- `-v` `--logging` — настройка логирования

### Настройка переменных окружения
Создайте файл .env в корне проекта. Пример представлен в .env.example:
```
SERVER_PROTOCOL='ws://'
SERVER_HOST=127.0.0.1
ROUTES_NUMBER=50
BUSES_PER_ROUTE=2
WEBSOCKETS_NUMBER=20
PREFIX_EMULATOR_ID=''
COORD_REFRESH_TIMEOUT=1
LOGGING=''

BUS_PORT=8001
BROWSER_PORT=8080
```

## Настройки

Внизу справа на странице можно включить отладочный режим логгирования и указать нестандартный адрес веб-сокета.

<img src="screenshots/settings.png" alt="settings">

Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.

Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.

## Формат данных

Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:

```json
{
  "msgType": "Buses",
  "buses": [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"},
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:

```json
{
  "msgType": "newBounds",
  "data": {
    "east_lng": 37.65563964843751,
    "north_lat": 55.77367652953477,
    "south_lat": 55.72628839374007,
    "west_lng": 37.54440307617188
  }
}
```

## Запуск тестов
Для запуска тестов необходимо применить команду
```shell
pytest core/tests.py
```

## Используемые библиотеки

- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) для логирования
